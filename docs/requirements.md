# 要件定義

## 1. 目的
同一プロンプトをN回生成し、LLM出力の揺らぎを
- **頻度（統計）**
- **文字遷移グラフ（グラフ構造）**
で示す。加えて、ごく稀なハルシネーション（期待回答からの逸脱）を実例として採集する。

## 2. スコープ
### In-scope
- 単一プロンプトに対するN回実行（最大10,000）
- 高並列実行
- 生成結果の保存（全件 or サンプリング）
- 文字単位のグラフ集計（trie）
- JSON出力

### Out-of-scope
- GUI / Web可視化
- logprobs取得
- 多プロンプト一括運用（将来拡張）
- 配布・インストーラ化

## 3. 機能要件
### 3.1 実行
- 入力: prompt（<=50文字想定）、N、並列数、モデル、生成パラメータ
- 出力: JSON（生結果 + 集計結果 + 実行メタデータ）

### 3.2 収集
- 同一設定でN回実行
- 失敗（429/5xx/timeout）時のリトライ
- 収集の進捗（ログ）と中断時の扱い（部分結果を残す）

### 3.3 集計（グラフ）
- 生成テキストをUnicode文字列として処理し、先頭から1文字ずつ遷移をカウント
- ノード: prefix（空文字から開始）
- エッジ: (prefix -> prefix+char) を count で保持
- 付随統計:
  - 深さdごとの分岐数、上位k文字、エントロピー
  - 最頻パス（mode出力）とその比率

### 3.4 ハルシネーション（逸脱）抽出（任意設定）
- ユーザー定義の「期待回答（正解集合）」を設定可能にする
- 生成結果が期待集合に入らない場合に "deviation" として記録し、例を収集
- 逸脱判定はまずは単純（完全一致/正規化一致）でよい

## 4. 非機能要件
- **最速収集**優先（拡張性は二の次）
- 10,000回で破綻しないメモリ・書き込み設計
- 再現性のため、実行時のパラメータ・ライブラリ情報をJSONに保存

## 5. 制約・前提
- OpenAI Responses API を使用
- 価格やレート制限はアカウント/モデルで変動するため、429を前提に制御する
- 出力長が長いとコストと時間が増えるため、max_output_tokens を小さめに制御できること

## 6. 未確定事項（埋めると仕様が確定）
- 出力の想定長（例: 1トークン相当/短文/数文）
- temperature/top_p をどうするか（揺らぎを見せたいならtemperature>0）
- 出力の正規化方針（例: 前後空白除去、改行除去、句読点統一など）
- 逸脱判定の定義（完全一致で十分か、正規化一致か）
- 生データ保存方針（全件保存 vs 逸脱のみ保存 vs 上位頻出のみ保存）
